# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           cmake 1.0

# TODO: temporary - if checksums are desired
PortGroup           github 1.0
github.setup        mojca opengate 6957d3641f

## official repository
# fetch.type          git
# git.url             http://git.opengatecollaboration.org/git/opengate-public.git
# git.branch          6957d3641f0b6a11285326a733ca1b3d7d39dfe6

## previous release (would need quite some patches to start working)
# distfiles           gate_v6_2_tar_gz_15843.gz
# master_sites        http://www.opengatecollaboration.org/sites/opengatecollaboration.org/files/gate_release/2012/08/

name                gate
version             6.2
categories          science
maintainers         mojca
license             LGPL
description         GATE description
long_description    GATE is dedicated to numerical simulations in medical imaging and radiotherapy. \
                    It currently supports simulations of Emission Tomography (PET and SPECT), \
                    Computed Tomography (CT) and Radiotherapy experiments.
homepage            http://www.opengatecollaboration.org
platforms           darwin

checksums           rmd160  473358e39e3e7170381bc3e8de42b9c779ff38d2 \
                    sha256  7518d385ad8612c495e90d9da82511c96f19be380b240d221aa2cb87818ef105

set geant.data_versions_9.6 {
    G4NDL              4.2   G4NDL                G4NEUTRONHPDATA
    G4EMLOW            6.32  G4EMLOW              G4LEDATA
    PhotonEvaporation  2.3   G4PhotonEvaporation  G4LEVELGAMMADATA
    RadioactiveDecay   3.6   G4RadioactiveDecay   G4RADIOACTIVEDATA
    G4NEUTRONXS        1.2   G4NEUTRONXS          G4NEUTRONXSDATA
    G4PII              1.3   G4PII                G4PIIDATA
    RealSurface        1.0   RealSurface          G4REALSURFACEDATA
    G4SAIDDATA         1.1   G4SAIDDATA           G4SAIDXSDATA
}
set geant.data_versions_9.5 {
    G4NDL              4.2   G4NDL                G4NEUTRONHPDATA
    G4EMLOW            6.32  G4EMLOW              G4LEDATA
    PhotonEvaporation  2.3   G4PhotonEvaporation  G4LEVELGAMMADATA
    RadioactiveDecay   3.6   G4RadioactiveDecay   G4RADIOACTIVEDATA
    G4ABLA             3.0   G4ABLA               G4ABLADATA
    G4NEUTRONXS        1.1   G4NEUTRONXS          G4NEUTRONXSDATA
    G4PII              1.3   G4PII                G4PIIDATA
    RealSurface        1.0   RealSurface          G4REALSURFACEDATA
}
set geant.datadir ""
set geant.data_versions ""

worksrcdir          gate_v${version}
configure.dir       ${workpath}/build
build.dir           ${configure.dir}

post-extract {
    file mkdir ${configure.dir}
}

configure.post_args ${worksrcpath}

# copy examples
# TODO: this must be done in a better way
post-patch {
    # replace "/vis/open OGLIX" with "/vis/open OGLIQt" (not sure about the difference between OGLIQt and OGLSQt)
    foreach examplefile {gpumacros/ct/mac/visu.mac gpumacros/optical/macro_biolum_cpu.mac gpumacros/optical/macro_biolum_gpu.mac gpumacros/pet/mac/visu.mac gpumacros/photradthera/mac/visu.mac example_CT/classic/visu.mac example_CT/fast/visu.mac example_CT/vrt/visu.mac example_OPTICAL/macro/Visualisation.mac example_PET/PET_CylindricalPET_System.mac example_PET/PET_Ecat_System.mac example_PHANTOM_SOURCE/Voxelized_Phantom_Source/mainMacro.mac example_SPECT/vis.mac example_TimeActivityCurve/vis.mac example_TrackerDetector/visu.mac} {
        reinplace "s|OGLIX|OGLIQt|g" ${worksrcpath}/examples/${examplefile}
        reinplace "s|OGLSX|OGLIQt|g" ${worksrcpath}/examples/${examplefile}
        system "echo ${examplefile}"
    }
}
pre-destroot {
    # copy examples
    # Should examples go to share/doc/gate or to share/gate/doc?
    set destdocdir ${destroot}${prefix}/share/doc/${name}
    xinstall -m 755 -d ${destdocdir}
    copy ${worksrcpath}/examples ${destdocdir}
    # TODO: remove CMake files and add material database
    # add materials database
    set sharedir ${prefix}/share/${name}
    set destsharedir ${destroot}${sharedir}
    xinstall -m 755 -d ${destsharedir}
    copy ${worksrcpath}/GateMaterials.db ${destsharedir}
    copy ${worksrcpath}/GateMaterialsGPU.db ${destsharedir}
}

post-destroot {
    # TODO: this is already set in another phase and should not repeat
    set sharedir ${prefix}/share/${name}
    # move the binary and set environmental variables
    set destexecutable ${destroot}${prefix}/bin/Gate
    set libexecdir ${prefix}/libexec/${name}
    set destlibexecdir ${destroot}${libexecdir}
    xinstall -m 755 -d ${destlibexecdir}
    move ${destexecutable} ${destlibexecdir}
    system "echo \\\$GATEHOME=${sharedir} > ${destexecutable}"
    system "echo export G4DATADIR=${geant.datadir} > ${destexecutable}"
    foreach {data.name data.version data.filename data.envvariable} ${geant.data_versions} {
        system "echo export ${data.envvariable}=\\\$G4DATADIR/${data.name}${data.version} >> ${destexecutable}"
    }
    system "echo export LC_NUMERIC=C >> ${destexecutable}"
    system "echo ${libexecdir}/Gate \\\$@ >> ${destexecutable}"
    system "chmod 755 ${destexecutable}"
}

variant geant495 conflicts geant496 description {Use Geant4 9.5} {
    depends_lib port:geant4-9.5
    # TODO: this can probably be done in a more elegant way
    set geant.data_versions ${geant.data_versions_9.5}
    set geant.datadir ${prefix}/share/Geant4/Data/Geant4.9.5
    # TODO: how to copy this from geant4 suports?
    configure.args-append -DGeant4_DIR=${prefix}/lib/Geant4/Geant4.9.6/Geant4-9.5.2
}
variant geant496 conflicts geant495 description {Use Geant4 9.6} {
    depends_lib port:geant4-9.6
    # TODO: this can probably be done in a more elegant way
    set geant.data_versions ${geant.data_versions_9.6}
    set geant.datadir ${prefix}/share/Geant4/Data/Geant4.9.6
    # TODO: how to copy this from geant4 suports?
    configure.args-append -DGeant4_DIR=${prefix}/lib/Geant4/Geant4.9.6/Geant4-9.6.2
}
if {![variant_isset geant495] && ![variant_isset geant496]} {
    default_variants +geant496
}

configure.args-append -DGATE_USE_SYSTEM_CLHEP=ON
