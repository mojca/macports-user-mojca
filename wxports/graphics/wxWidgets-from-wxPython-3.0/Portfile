# -*- coding: utf-8; mode: tcl; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=2:ts=2:sts=2
# $Id$

PortSystem          1.0
PortGroup           select          1.0
PortGroup           wxWidgets       1.0
# temporary conflict to prevent wrong linking
PortGroup           conflicts_build 1.0

wxWidgets.use       wxPython-3.0
name                ${wxWidgets.port}
# (temporary)
conflicts_build     wxgtk wxWidgets wxWidgets-python wxWidgets30 wxWidgets-devel
version             2.9.4.0
set branch          [join [lrange [split ${version} .] 0 1] .]

categories          graphics devel
platforms           darwin
license             wxwidgets-3.1
maintainers         jwa mojca

description         wxWidgets ${branch} taken from the wxPython distribution
long_description    The port installs wxWidgets ${branch} from wxPython sources \
                    to guarantee compatibility even when upstream versions \
                    of wxWidgets and wxPython differ.

homepage            http://www.wxpython.org/
master_sites        sourceforge:wxpython

distname            wxPython
use_bzip2           yes

distfiles           ${distname}-src-${version}${extract.suffix}
dist_subdir         ${distname}/${version}

checksums           rmd160  35e823d9161dc99083f3025383567000680e012f \
                    sha256  78c35c19e85a17cb9c730b86b49d6a479198d76d19e0b13e86db0b55707004be

depends_lib         port:jpeg \
                    port:tiff \
                    port:libpng \
                    port:zlib \
                    port:libiconv \
                    port:expat

depends_run         port:wxWidgets_select

select.group        wxWidgets
select.file         ${filespath}/${name}

worksrcdir          ${distname}-src-${version}/build
configure.cmd       ../configure

configure.args      --prefix=${wxWidgets.prefix} \
                    --with-libjpeg \
                    --with-libtiff \
                    --with-libpng \
                    --with-zlib \
                    --with-opengl \
                    --with-cocoa \
                    --without-sdl \
                    --disable-sdltest \
                    --enable-unicode \
                    --enable-display \
                    --enable-xrc \
                    --enable-graphics_ctx \
                    --with-macosx-sdk=no \
                    --with-macosx-version-min=no

variant universal {
    set archs [join ${configure.universal_archs} ,]
    configure.args-append   --enable-universal_binary=${archs}
}

# TODO: what is this?
configure.ccache    no

# variant monolithic description {build only one library} {
#     configure.args-append   --enable-monolithic
# }

variant debug description {add debug info to libraries} {
    configure.args-append   --enable-debug
}

# variant stdlib description {add support for various standard library features} {
#     configure.args-append   --enable-stl \
#                             --enable-std_containers \
#                             --enable-std_iostreams \
#                             --enable-std_string \
#                             --enable-std_string_conv_in_wxstring
# }
# 
# variant aui description {add support for AUI docking library} {
#     configure.args-append   --enable-aui
# }

post-build {
    # TODO: bug; try to figure out why this linking problem happens instead of just fixing it
    # libwx_baseu_xml-2.9.4.0.0.dylib and libwx_baseu-2.9.4.0.0.dylib

    foreach {lib} "libwx_baseu_xml-${version}.0.dylib and libwx_baseu-${version}.0.dylib" {
        system "install_name_tool -change ${build.dir}/lib/${lib} ${wxWidgets.prefix}/lib/${lib} ${build.dir}/utils/wxrc/wxrc"
    }
}

post-destroot {
    # foreach c { ${contrib} } {
    #     system -W ${build.dir} "make -C contrib/src/${c} install ${destroot.destdir}"
    # }
    ## TODO
    # xinstall -d -m 755 ${destroot}${prefix}/share/doc/${name}
    # xinstall -m 644 -W ${workpath}/${distname}-${version} \
    #    changes.txt gpl.txt lgpl.txt licence.txt preamble.txt readme.txt \
    #    osx/install.txt osx/readme.txt
    #    ${destroot}${prefix}/share/doc/${name}
    set confscript ${wxWidgets.prefix}/lib/wx/config/osx_cocoa-unicode-${branch}
    ln -sf ${confscript} ${destroot}${wxWidgets.prefix}/bin/wx-config
}

livecheck.type      regex
livecheck.url       ${homepage}
livecheck.regex     wxPython(?: | \\(classic\\) )(2\\.\[0-9\]+\\.\[0-9\]+\\.\[0-9\]+)
